@inject Mas.Infrastructure.Common.ConnectionManager ConMan

@using BlazorDrawFBP.Renderers

<div>
    <MudCard Style="@CardStyle">
        @* <MudCardHeader> *@
        @*     <CardHeaderContent> *@
        @*         <MudTextField Class="d-inline-flex pr-4" *@
        @*                       @bind-Value="Node.ProcessName" *@
        @*                       Label="Process name" *@
        @*                       Variant="Variant.Outlined"/> *@
        @*         <MudToggleIconButton Style="position: absolute; right: -5px; top: 25px;" *@
        @*                              Toggled="@ProcessStarted" *@
        @*                              ToggledChanged="@StartProcess" *@
        @*                              Icon="@Icons.Material.Filled.PlayCircle" *@
        @*                              Color="@Color.Primary" *@
        @*                              title="@(ProcessStarted ? "Stop process" : "Start process")" *@
        @*                              ToggledIcon="@Icons.Material.Filled.StopCircle" *@
        @*                              ToggledColor="@Color.Secondary"/> *@
        @*     </CardHeaderContent> *@
        @* </MudCardHeader> *@
        <MudCardContent>
            <MudTextField Class="d-inline-flex pr-4"
                          @bind-Value="Node.ProcessName"
                          Label="Process name"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"/>
            <MudToggleIconButton Style="position: absolute; right: -5px; top: 25px;"
                                 Toggled="@ProcessStarted"
                                 ToggledChanged="@StartProcess"
                                 Icon="@Icons.Material.Filled.PlayCircle"
                                 Color="@Color.Primary"
                                 title="@(ProcessStarted ? "Stop process" : "Start process")"
                                 ToggledIcon="@Icons.Material.Filled.StopCircle"
                                 ToggledColor="@Color.Secondary"/>
            <Display WidthPx="@Node.DisplayWidthPx"
                     HeightPx="@Node.DisplayHeightPx">
                @Node.ViewContent
            </Display>
        </MudCardContent>
    </MudCard>

    @if (Node.Ports.Count > 0 && Node.Ports[0] is CapnpFbpPortModel capnpPort)
    {
        <CapnpFbpPortRenderer @key="Node.Ports[0]" Port="capnpPort" Style="top: 50%;">
            in
        </CapnpFbpPortRenderer>
    }
</div>

@code {
    [Parameter] public CapnpFbpViewComponentModel Node { get; set; } = null!;

    private string CardStyle => $"min-height: 100px; max-height: 800px; max-width: 800px; {FrameWidth}; {FrameColor}";

    private string FrameWidth => $"border-width: {(Node.Runnable == null ? 1 : 1)}px";
    private string FrameColor => $@"border-color: {(ProcessStarted ? "#1ac12e" : "#ff0000")}";

    private async Task StartProcess(bool start)
    {
        await Node.StartProcess(ConMan, start);
        StateHasChanged();
    }

    private bool ProcessStarted => Node.ProcessStarted;
}